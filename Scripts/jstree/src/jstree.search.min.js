(function(n){"use strict";typeof define=="function"&&define.amd?define("jstree.search",["jquery","jstree"],n):typeof exports=="object"?n(require("jquery"),require("jstree")):n(jQuery,jQuery.jstree)})(function(n){"use strict";n.jstree.plugins.search||(n.jstree.defaults.search={ajax:!1,fuzzy:!1,case_sensitive:!1,show_only_matches:!1,close_opened_onclear:!0,search_leaves_only:!1,search_callback:!1},n.jstree.plugins.search=function(t,i){this.bind=function(){i.bind.call(this);this._data.search.str="";this._data.search.dom=n();this._data.search.res=[];this._data.search.opn=[];this.element.on("before_open.jstree",n.proxy(function(){var r,f,i=this._data.search.res,t=[],u=n();if(i&&i.length&&(this._data.search.dom=n(this.element[0].querySelectorAll("#"+n.map(i,function(t){return"0123456789".indexOf(t[0])!==-1?"\\3"+t[0]+" "+t.substr(1).replace(n.jstree.idregex,"\\$&"):t.replace(n.jstree.idregex,"\\$&")}).join(", #"))),this._data.search.dom.children(".jstree-anchor").addClass("jstree-search"),this.settings.search.show_only_matches&&this._data.search.res.length)){for(r=0,f=i.length;r<f;r++)t=t.concat(this.get_node(i[r]).parents);t=n.vakata.array_remove_item(n.vakata.array_unique(t),"#");u=t.length?n(this.element[0].querySelectorAll("#"+n.map(t,function(t){return"0123456789".indexOf(t[0])!==-1?"\\3"+t[0]+" "+t.substr(1).replace(n.jstree.idregex,"\\$&"):t.replace(n.jstree.idregex,"\\$&")}).join(", #"))):n();this.element.find(".jstree-node").hide().filter(".jstree-last").filter(function(){return this.nextSibling}).removeClass("jstree-last");u=u.add(this._data.search.dom);u.parentsUntil(".jstree").addBack().show().filter(".jstree-children").each(function(){n(this).children(".jstree-node:visible").eq(-1).addClass("jstree-last")})}},this));if(this.settings.search.show_only_matches)this.element.on("search.jstree",function(t,i){i.nodes.length&&(n(this).find(".jstree-node").hide().filter(".jstree-last").filter(function(){return this.nextSibling}).removeClass("jstree-last"),i.nodes.parentsUntil(".jstree").addBack().show().filter(".jstree-children").each(function(){n(this).children(".jstree-node:visible").eq(-1).addClass("jstree-last")}))}).on("clear_search.jstree",function(t,i){i.nodes.length&&n(this).find(".jstree-node").css("display","").filter(".jstree-last").filter(function(){return this.nextSibling}).removeClass("jstree-last")})};this.search=function(t,i){if(t===!1||n.trim(t.toString())==="")return this.clear_search();t=t.toString();var u=this.settings.search,r=u.ajax?u.ajax:!1,o=null,e=[],f=[];if(this._data.search.res.length&&this.clear_search(),!i&&r!==!1)return n.isFunction(r)?r.call(this,t,n.proxy(function(i){i&&i.d&&(i=i.d);this._load_nodes(n.isArray(i)?n.vakata.array_unique(i):[],function(){this.search(t,!0)},!0)},this)):(r=n.extend({},r),r.data||(r.data={}),r.data.str=t,n.ajax(r).fail(n.proxy(function(){this._data.core.last_error={error:"ajax",plugin:"search",id:"search_01",reason:"Could not load search parents",data:JSON.stringify(r)};this.settings.core.error.call(this,this._data.core.last_error)},this)).done(n.proxy(function(i){i&&i.d&&(i=i.d);this._load_nodes(n.isArray(i)?n.vakata.array_unique(i):[],function(){this.search(t,!0)},!0)},this)));this._data.search.str=t;this._data.search.dom=n();this._data.search.res=[];this._data.search.opn=[];o=new n.vakata.search(t,!0,{caseSensitive:u.case_sensitive,fuzzy:u.fuzzy});n.each(this._model.data,function(n,i){i.text&&(u.search_callback&&u.search_callback.call(this,t,i)||!u.search_callback&&o.search(i.text).isMatch)&&(!u.search_leaves_only||i.state.loaded&&i.children.length===0)&&(e.push(n),f=f.concat(i.parents))});e.length&&(f=n.vakata.array_unique(f),this._search_open(f),this._data.search.dom=n(this.element[0].querySelectorAll("#"+n.map(e,function(t){return"0123456789".indexOf(t[0])!==-1?"\\3"+t[0]+" "+t.substr(1).replace(n.jstree.idregex,"\\$&"):t.replace(n.jstree.idregex,"\\$&")}).join(", #"))),this._data.search.res=e,this._data.search.dom.children(".jstree-anchor").addClass("jstree-search"));this.trigger("search",{nodes:this._data.search.dom,str:t,res:this._data.search.res})};this.clear_search=function(){this._data.search.dom.children(".jstree-anchor").removeClass("jstree-search");this.settings.search.close_opened_onclear&&this.close_node(this._data.search.opn,0);this.trigger("clear_search",{nodes:this._data.search.dom,str:this._data.search.str,res:this._data.search.res});this._data.search.str="";this._data.search.res=[];this._data.search.opn=[];this._data.search.dom=n()};this._search_open=function(t){var i=this;n.each(t.concat([]),function(r,u){if(u==="#")return!0;try{u=n("#"+u.replace(n.jstree.idregex,"\\$&"),i.element)}catch(f){}u&&u.length&&i.is_closed(u)&&(i._data.search.opn.push(u[0].id),i.open_node(u,function(){i._search_open(t)},0))})}},function(n){n.vakata.search=function(n,t,i){i=i||{};i.fuzzy!==!1&&(i.fuzzy=!0);n=i.caseSensitive?n:n.toLowerCase();var u=i.location||0,o=i.distance||100,c=i.threshold||.6,r=n.length,s,h,f,e;return r>32&&(i.fuzzy=!1),i.fuzzy&&(s=1<<r-1,h=function(){for(var i={},t=0,t=0;t<r;t++)i[n.charAt(t)]=0;for(t=0;t<r;t++)i[n.charAt(t)]|=1<<r-t-1;return i}(),f=function(n,t){var i=n/r,f=Math.abs(u-t);return o?i+f/o:f?1:i}),e=function(t){if(t=i.caseSensitive?t:t.toLowerCase(),n===t||t.indexOf(n)!==-1)return{isMatch:!0,score:0};if(!i.fuzzy)return{isMatch:!1,score:1};var a,e,tt=t.length,v=c,o=t.indexOf(n,u),p,l,w=r+tt,b,g,k,y,nt,d=1,it=[];for(o!==-1&&(v=Math.min(f(0,o),v),o=t.lastIndexOf(n,u+r),o!==-1&&(v=Math.min(f(0,o),v))),o=-1,a=0;a<r;a++){for(p=0,l=w;p<l;)f(a,u+l)<=v?p=l:w=l,l=Math.floor((w-p)/2+p);for(w=l,g=Math.max(1,u-l+1),k=Math.min(u+l,tt)+r,y=new Array(k+2),y[k+1]=(1<<a)-1,e=k;e>=g;e--)if(nt=h[t.charAt(e-1)],y[e]=a===0?(y[e+1]<<1|1)&nt:(y[e+1]<<1|1)&nt|(b[e+1]|b[e])<<1|1|b[e+1],y[e]&s&&(d=f(a,e-1),d<=v))if(v=d,o=e-1,it.push(o),o>u)g=Math.max(1,2*u-o);else break;if(f(a+1,u)>v)break;b=y}return{isMatch:o>=0,score:d}},t===!0?{search:e}:e(t)}}(jQuery))});