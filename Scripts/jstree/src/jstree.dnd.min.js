(function(n){"use strict";typeof define=="function"&&define.amd?define("jstree.dnd",["jquery","jstree"],n):typeof exports=="object"?n(require("jquery"),require("jstree")):n(jQuery,jQuery.jstree)})(function(n){"use strict";n.jstree.plugins.dnd||(n.jstree.defaults.dnd={copy:!0,open_timeout:500,is_draggable:!0,check_while_dragging:!0,always_copy:!1,inside_pos:0},n.jstree.plugins.dnd=function(t,i){this.bind=function(){i.bind.call(this);this.element.on("mousedown.jstree touchstart.jstree",".jstree-anchor",n.proxy(function(t){var i=this.get_node(t.target),r=this.is_selected(i)?this.get_selected().length:1;if(i&&i.id&&i.id!=="#"&&(t.which===1||t.type==="touchstart")&&(this.settings.dnd.is_draggable===!0||n.isFunction(this.settings.dnd.is_draggable)&&this.settings.dnd.is_draggable.call(this,r>1?this.get_selected(!0):[i])))return this.element.trigger("mousedown.jstree"),n.vakata.dnd.start(t,{jstree:!0,origin:this,obj:this.get_node(i,!0),nodes:r>1?this.get_selected():[i.id]},'<div id="jstree-dnd" class="jstree-'+this.get_theme()+(this.settings.core.themes.responsive?" jstree-dnd-responsive":"")+'"><i class="jstree-icon jstree-er"><\/i>'+(r>1?r+" "+this.get_string("nodes"):this.get_text(t.currentTarget,!0))+'<ins class="jstree-copy" style="display:none;">+<\/ins><\/div>')},this))}},n(function(){var t=!1,i=!1,u=!1,r=n('<div id="jstree-marker">&#160;<\/div>').hide().appendTo("body");n(document).bind("dnd_start.vakata",function(){t=!1}).bind("dnd_move.vakata",function(f,e){if((u&&clearTimeout(u),e.data.jstree)&&(!e.event.target.id||e.event.target.id!=="jstree-marker")){var o=n.jstree.reference(e.event.target),s=!1,l=!1,b=!1,k,d,a,v,y,g,c,h,nt,it,tt,rt,p,w;if(o&&o._data&&o._data.dnd)if(r.attr("class","jstree-"+o.get_theme()+(o.settings.core.themes.responsive?" jstree-dnd-responsive":"")),e.helper.children().attr("class","jstree-"+o.get_theme()+(o.settings.core.themes.responsive?" jstree-dnd-responsive":"")).find(".jstree-copy:eq(0)")[e.data.origin&&(e.data.origin.settings.dnd.always_copy||e.data.origin.settings.dnd.copy&&(e.event.metaKey||e.event.ctrlKey))?"show":"hide"](),(e.event.target===o.element[0]||e.event.target===o.get_container_ul()[0])&&o.get_container_ul().children().length===0){for(c=!0,h=0,nt=e.data.nodes.length;h<nt;h++)if(c=c&&o.check(e.data.origin&&(e.data.origin.settings.dnd.always_copy||e.data.origin.settings.dnd.copy&&(e.event.metaKey||e.event.ctrlKey))?"copy_node":"move_node",e.data.origin&&e.data.origin!==o?e.data.origin.get_node(e.data.nodes[h]):e.data.nodes[h],"#","last",{dnd:!0,ref:o.get_node("#"),pos:"i",is_multi:e.data.origin&&e.data.origin!==o,is_foreign:!e.data.origin}),!c)break;if(c){t={ins:o,par:"#",pos:"last"};r.hide();e.helper.find(".jstree-icon:eq(0)").removeClass("jstree-er").addClass("jstree-ok");return}}else if(s=n(e.event.target).closest(".jstree-anchor"),s&&s.length&&s.parent().is(".jstree-closed, .jstree-open, .jstree-leaf")&&(l=s.offset(),b=e.event.pageY-l.top,a=s.height(),g=b<a/3?["b","i","a"]:b>a-a/3?["a","i","b"]:b>a/2?["i","a","b"]:["i","b","a"],n.each(g,function(f,b){switch(b){case"b":k=l.left-6;d=l.top;v=o.get_parent(s);y=s.parent().index();break;case"i":p=o.settings.dnd.inside_pos;w=o.get_node(s.parent());k=l.left-2;d=l.top+a/2+1;v=w.id;y=p==="first"?0:p==="last"?w.children.length:Math.min(p,w.children.length);break;case"a":k=l.left-6;d=l.top+a;v=o.get_parent(s);y=s.parent().index()+1}
/*!
								// TODO: moving inside, but the node is not yet loaded?
								// the check will work anyway, as when moving the node will be loaded first and checked again
								if(v === 'i' && !ins.is_loaded(p)) { }
								*/
for(c=!0,h=0,nt=e.data.nodes.length;h<nt;h++)if(it=e.data.origin&&(e.data.origin.settings.dnd.always_copy||e.data.origin.settings.dnd.copy&&(e.event.metaKey||e.event.ctrlKey))?"copy_node":"move_node",tt=y,it==="move_node"&&b==="a"&&e.data.origin&&e.data.origin===o&&v===o.get_parent(e.data.nodes[h])&&(rt=o.get_node(v),tt>n.inArray(e.data.nodes[h],rt.children)&&(tt-=1)),c=c&&(o&&o.settings&&o.settings.dnd&&o.settings.dnd.check_while_dragging===!1||o.check(it,e.data.origin&&e.data.origin!==o?e.data.origin.get_node(e.data.nodes[h]):e.data.nodes[h],v,tt,{dnd:!0,ref:o.get_node(s.parent()),pos:b,is_multi:e.data.origin&&e.data.origin!==o,is_foreign:!e.data.origin})),!c){o&&o.last_error&&(i=o.last_error());break}if(c)return b==="i"&&s.parent().is(".jstree-closed")&&o.settings.dnd.open_timeout&&(u=setTimeout(function(n,t){return function(){n.open_node(t)}}(o,s),o.settings.dnd.open_timeout)),t={ins:o,par:v,pos:b==="i"&&p==="last"&&y===0&&!o.is_loaded(w)?"last":y},r.css({left:k+"px",top:d+"px"}).show(),e.helper.find(".jstree-icon:eq(0)").removeClass("jstree-er").addClass("jstree-ok"),i={},g=!0,!1}),g===!0))return;t=!1;e.helper.find(".jstree-icon").removeClass("jstree-ok").addClass("jstree-er");r.hide()}}).bind("dnd_scroll.vakata",function(n,i){i.data.jstree&&(r.hide(),t=!1,i.helper.find(".jstree-icon:eq(0)").removeClass("jstree-ok").addClass("jstree-er"))}).bind("dnd_stop.vakata",function(f,e){if(u&&clearTimeout(u),e.data.jstree){r.hide();var o,h,s=[];if(t){for(o=0,h=e.data.nodes.length;o<h;o++)s[o]=e.data.origin?e.data.origin.get_node(e.data.nodes[o]):e.data.nodes[o],e.data.origin&&(s[o].instance=e.data.origin);t.ins[e.data.origin&&(e.data.origin.settings.dnd.always_copy||e.data.origin.settings.dnd.copy&&(e.event.metaKey||e.event.ctrlKey))?"copy_node":"move_node"](s,t.par,t.pos)}else o=n(e.event.target).closest(".jstree"),o.length&&i&&i.error&&i.error==="check"&&(o=o.jstree(!0),o&&o.settings.core.error.call(this,i))}}).bind("keyup keydown",function(t,i){i=n.vakata.dnd._get();i.data&&i.data.jstree&&i.helper.find(".jstree-copy:eq(0)")[i.data.origin&&(i.data.origin.settings.dnd.always_copy||i.data.origin.settings.dnd.copy&&(t.metaKey||t.ctrlKey))?"show":"hide"]()})}),function(n){var t={element:!1,target:!1,is_down:!1,is_drag:!1,helper:!1,helper_w:0,data:!1,init_x:0,init_y:0,scroll_l:0,scroll_t:0,scroll_e:!1,scroll_i:!1,is_touch:!1};n.vakata.dnd={settings:{scroll_speed:10,scroll_proximity:20,helper_left:5,helper_top:10,threshold:5,threshold_touch:50},_trigger:function(t,i){var r=n.vakata.dnd._get();r.event=i;n(document).triggerHandler("dnd_"+t+".vakata",r)},_get:function(){return{data:t.data,element:t.element,helper:t.helper}},_clean:function(){t.helper&&t.helper.remove();t.scroll_i&&(clearInterval(t.scroll_i),t.scroll_i=!1);t={element:!1,target:!1,is_down:!1,is_drag:!1,helper:!1,helper_w:0,data:!1,init_x:0,init_y:0,scroll_l:0,scroll_t:0,scroll_e:!1,scroll_i:!1,is_touch:!1};n(document).off("mousemove touchmove",n.vakata.dnd.drag);n(document).off("mouseup touchend",n.vakata.dnd.stop)},_scroll:function(i){if(!t.scroll_e||!t.scroll_l&&!t.scroll_t)return t.scroll_i&&(clearInterval(t.scroll_i),t.scroll_i=!1),!1;if(!t.scroll_i)return t.scroll_i=setInterval(n.vakata.dnd._scroll,100),!1;if(i===!0)return!1;var r=t.scroll_e.scrollTop(),u=t.scroll_e.scrollLeft();t.scroll_e.scrollTop(r+t.scroll_t*n.vakata.dnd.settings.scroll_speed);t.scroll_e.scrollLeft(u+t.scroll_l*n.vakata.dnd.settings.scroll_speed);(r!==t.scroll_e.scrollTop()||u!==t.scroll_e.scrollLeft())&&n.vakata.dnd._trigger("scroll",t.scroll_e)},start:function(i,r,u){i.type==="touchstart"&&i.originalEvent&&i.originalEvent.changedTouches&&i.originalEvent.changedTouches[0]&&(i.pageX=i.originalEvent.changedTouches[0].pageX,i.pageY=i.originalEvent.changedTouches[0].pageY,i.target=document.elementFromPoint(i.originalEvent.changedTouches[0].pageX-window.pageXOffset,i.originalEvent.changedTouches[0].pageY-window.pageYOffset));t.is_drag&&n.vakata.dnd.stop({});try{i.currentTarget.unselectable="on";i.currentTarget.onselectstart=function(){return!1};i.currentTarget.style&&(i.currentTarget.style.MozUserSelect="none")}catch(f){}return t.init_x=i.pageX,t.init_y=i.pageY,t.data=r,t.is_down=!0,t.element=i.currentTarget,t.target=i.target,t.is_touch=i.type==="touchstart",u!==!1&&(t.helper=n("<div id='vakata-dnd'><\/div>").html(u).css({display:"block",margin:"0",padding:"0",position:"absolute",top:"-2000px",lineHeight:"16px",zIndex:"10000"})),n(document).bind("mousemove touchmove",n.vakata.dnd.drag),n(document).bind("mouseup touchend",n.vakata.dnd.stop),!1},drag:function(i){if(i.type==="touchmove"&&i.originalEvent&&i.originalEvent.changedTouches&&i.originalEvent.changedTouches[0]&&(i.pageX=i.originalEvent.changedTouches[0].pageX,i.pageY=i.originalEvent.changedTouches[0].pageY,i.target=document.elementFromPoint(i.originalEvent.changedTouches[0].pageX-window.pageXOffset,i.originalEvent.changedTouches[0].pageY-window.pageYOffset)),t.is_down){if(!t.is_drag)if(Math.abs(i.pageX-t.init_x)>(t.is_touch?n.vakata.dnd.settings.threshold_touch:n.vakata.dnd.settings.threshold)||Math.abs(i.pageY-t.init_y)>(t.is_touch?n.vakata.dnd.settings.threshold_touch:n.vakata.dnd.settings.threshold))t.helper&&(t.helper.appendTo("body"),t.helper_w=t.helper.outerWidth()),t.is_drag=!0,n.vakata.dnd._trigger("start",i);else return;var r=!1,c=!1,u=!1,e=!1,f=!1,o=!1,l=!1,a=!1,s=!1,h=!1;return t.scroll_t=0,t.scroll_l=0,t.scroll_e=!1,n(n(i.target).parentsUntil("body").addBack().get().reverse()).filter(function(){return/^auto|scroll$/.test(n(this).css("overflow"))&&(this.scrollHeight>this.offsetHeight||this.scrollWidth>this.offsetWidth)}).each(function(){var u=n(this),r=u.offset();return this.scrollHeight>this.offsetHeight&&(r.top+u.height()-i.pageY<n.vakata.dnd.settings.scroll_proximity&&(t.scroll_t=1),i.pageY-r.top<n.vakata.dnd.settings.scroll_proximity&&(t.scroll_t=-1)),this.scrollWidth>this.offsetWidth&&(r.left+u.width()-i.pageX<n.vakata.dnd.settings.scroll_proximity&&(t.scroll_l=1),i.pageX-r.left<n.vakata.dnd.settings.scroll_proximity&&(t.scroll_l=-1)),t.scroll_t||t.scroll_l?(t.scroll_e=n(this),!1):void 0}),t.scroll_e||(r=n(document),c=n(window),u=r.height(),e=c.height(),f=r.width(),o=c.width(),l=r.scrollTop(),a=r.scrollLeft(),u>e&&i.pageY-l<n.vakata.dnd.settings.scroll_proximity&&(t.scroll_t=-1),u>e&&e-(i.pageY-l)<n.vakata.dnd.settings.scroll_proximity&&(t.scroll_t=1),f>o&&i.pageX-a<n.vakata.dnd.settings.scroll_proximity&&(t.scroll_l=-1),f>o&&o-(i.pageX-a)<n.vakata.dnd.settings.scroll_proximity&&(t.scroll_l=1),(t.scroll_t||t.scroll_l)&&(t.scroll_e=r)),t.scroll_e&&n.vakata.dnd._scroll(!0),t.helper&&(s=parseInt(i.pageY+n.vakata.dnd.settings.helper_top,10),h=parseInt(i.pageX+n.vakata.dnd.settings.helper_left,10),u&&s+25>u&&(s=u-50),f&&h+t.helper_w>f&&(h=f-(t.helper_w+2)),t.helper.css({left:h+"px",top:s+"px"})),n.vakata.dnd._trigger("move",i),!1}},stop:function(i){if(i.type==="touchend"&&i.originalEvent&&i.originalEvent.changedTouches&&i.originalEvent.changedTouches[0]&&(i.pageX=i.originalEvent.changedTouches[0].pageX,i.pageY=i.originalEvent.changedTouches[0].pageY,i.target=document.elementFromPoint(i.originalEvent.changedTouches[0].pageX-window.pageXOffset,i.originalEvent.changedTouches[0].pageY-window.pageYOffset)),t.is_drag)n.vakata.dnd._trigger("stop",i);else if(i.type==="touchend"&&i.target===t.target){var r=setTimeout(function(){n(i.target).click()},100);n(i.target).one("click",function(){r&&clearTimeout(r)})}return n.vakata.dnd._clean(),!1}}}(jQuery))});